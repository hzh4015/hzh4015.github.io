<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Notes | Notes</title><meta name="keywords" content="hadoop spark kafka Hbase Hive flink"><meta name="author" content="秋水一色"><meta name="copyright" content="秋水一色"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="TopN问题需要确定使用什么排名函数，包含三种函数：row_number()、rank()、dense_rank() 每个班级的分数为前3名的学生 --建表语句create table score(sid string, class string, score int)row format delimited fields terminated by &amp;#x27; &amp;#x27;;load data">
<meta property="og:type" content="article">
<meta property="og:title" content="Notes">
<meta property="og:url" content="http://example.com/2022/08/19/SQL%E7%AC%94%E8%AF%95%E9%A2%98/index.html">
<meta property="og:site_name" content="Notes">
<meta property="og:description" content="TopN问题需要确定使用什么排名函数，包含三种函数：row_number()、rank()、dense_rank() 每个班级的分数为前3名的学生 --建表语句create table score(sid string, class string, score int)row format delimited fields terminated by &amp;#x27; &amp;#x27;;load data">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2022/07/05/3zJOcWHCiKjMVZT.jpg">
<meta property="article:published_time" content="2022-08-19T00:57:49.909Z">
<meta property="article:modified_time" content="2022-08-19T00:55:55.759Z">
<meta property="article:author" content="秋水一色">
<meta property="article:tag" content="hadoop spark kafka Hbase Hive flink">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2022/07/05/3zJOcWHCiKjMVZT.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2022/08/19/SQL%E7%AC%94%E8%AF%95%E9%A2%98/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Notes',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-08-19 08:55:55'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/background.css"><meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="Notes" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2022/03/30/mD5ZV7wdUBGl62S.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">43</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s2.loli.net/2022/07/05/3zJOcWHCiKjMVZT.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Notes</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">无题</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-08-19T00:57:49.909Z" title="发表于 2022-08-19 08:57:49">2022-08-19</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-08-19T00:55:55.759Z" title="更新于 2022-08-19 08:55:55">2022-08-19</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h5 id="TopN问题"><a href="#TopN问题" class="headerlink" title="TopN问题"></a>TopN问题</h5><p>需要确定使用什么排名函数，包含三种函数：row_number()、rank()、dense_rank()</p>
<p>每个班级的分数为前3名的学生</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--建表语句</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> score(sid string, class string, score <span class="type">int</span>)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/temp/sql.txt&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> score;</span><br><span class="line"></span><br><span class="line"><span class="comment">--数据：学生id、班级、分数</span></span><br><span class="line">s1 A <span class="number">89</span></span><br><span class="line">s2 C <span class="number">88</span></span><br><span class="line">s3 A <span class="number">92</span></span><br><span class="line">s4 A <span class="number">89</span></span><br><span class="line">s5 B <span class="number">90</span></span><br><span class="line">s6 B <span class="number">86</span></span><br><span class="line">s7 C <span class="number">92</span></span><br><span class="line">s8 C <span class="number">90</span></span><br><span class="line">s9 A <span class="number">85</span></span><br><span class="line">s10 C <span class="number">86</span></span><br><span class="line">s11 B <span class="number">86</span></span><br><span class="line">s12 B <span class="number">86</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--sql语句</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> class, sid, score, <span class="built_in">dense_rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> class <span class="keyword">order</span> <span class="keyword">by</span> score <span class="keyword">desc</span>) <span class="keyword">as</span> rank</span><br><span class="line">    <span class="keyword">from</span> score</span><br><span class="line">) t1</span><br><span class="line"><span class="keyword">where</span> t1.rank <span class="operator">&lt;</span> <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--结果</span></span><br><span class="line">t1.class	t1.sid	t1.score	t1.rank</span><br><span class="line">A	s3	<span class="number">92</span>	<span class="number">1</span></span><br><span class="line">A	s4	<span class="number">89</span>	<span class="number">2</span></span><br><span class="line">A	s1	<span class="number">89</span>	<span class="number">2</span></span><br><span class="line">A	s9	<span class="number">85</span>	<span class="number">3</span></span><br><span class="line">B	s5	<span class="number">90</span>	<span class="number">1</span></span><br><span class="line">B	s11	<span class="number">86</span>	<span class="number">2</span></span><br><span class="line">B	s12	<span class="number">86</span>	<span class="number">2</span></span><br><span class="line">B	s6	<span class="number">86</span>	<span class="number">2</span></span><br><span class="line">C	s7	<span class="number">92</span>	<span class="number">1</span></span><br><span class="line">C	s8	<span class="number">90</span>	<span class="number">2</span></span><br><span class="line">C	s2	<span class="number">88</span>	<span class="number">3</span></span><br></pre></td></tr></table></figure>

<h5 id="行列转换问题"><a href="#行列转换问题" class="headerlink" title="行列转换问题"></a>行列转换问题</h5><p>（1）一行转换为多行</p>
<p>将每个电影的分类列表拆分出单个分类</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--建表语句</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> movie(movie_name string, category string)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/temp/sql.txt&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> movie;</span><br><span class="line"></span><br><span class="line"><span class="comment">--数据：电影名、分类</span></span><br><span class="line">让子弹飞 动作、年代</span><br><span class="line">长江七号 科幻</span><br><span class="line">大进军 战争</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--sql语句</span></span><br><span class="line"><span class="keyword">select</span> movie_name, category_name</span><br><span class="line"><span class="keyword">from</span> movie</span><br><span class="line"><span class="keyword">lateral</span> <span class="keyword">view</span> explode(split(category, <span class="string">&#x27;、&#x27;</span>)) t1 <span class="keyword">as</span> category_name;</span><br><span class="line"></span><br><span class="line"><span class="comment">--结果</span></span><br><span class="line">movie_name	category_name</span><br><span class="line">让子弹飞	动作</span><br><span class="line">让子弹飞	年代</span><br><span class="line">长江七号	科幻</span><br><span class="line">大进军	战争</span><br></pre></td></tr></table></figure>

<p>（2）多行转换为一行</p>
<p>将年龄相同的姓名合并在一起</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--建表语句</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> person(name string, age <span class="type">int</span>)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/temp/sql.txt&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> person;</span><br><span class="line"></span><br><span class="line"><span class="comment">--数据：姓名、年龄</span></span><br><span class="line">A <span class="number">20</span></span><br><span class="line">B <span class="number">18</span></span><br><span class="line">C <span class="number">20</span></span><br><span class="line">D <span class="number">24</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--sql语句</span></span><br><span class="line"><span class="keyword">select</span> concat_ws(<span class="string">&#x27;|&#x27;</span>, collect_set(name)) <span class="keyword">as</span> name_list, age</span><br><span class="line"><span class="keyword">from</span> person</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> age;</span><br><span class="line"></span><br><span class="line"><span class="comment">--结果</span></span><br><span class="line">name_list	age</span><br><span class="line">B	<span class="number">18</span></span><br><span class="line">A<span class="operator">|</span>C	<span class="number">20</span></span><br><span class="line">D	<span class="number">24</span></span><br></pre></td></tr></table></figure>

<p>将可枚举的值作为新的字段</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--建表语句</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> game(<span class="keyword">year</span> <span class="type">int</span>, class string, score <span class="type">int</span>)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/temp/sql.txt&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> game;</span><br><span class="line"></span><br><span class="line"><span class="comment">--数据：年份、班级、得分</span></span><br><span class="line"><span class="number">2020</span> ClassA <span class="number">10</span></span><br><span class="line"><span class="number">2020</span> ClassB <span class="number">12</span></span><br><span class="line"><span class="number">2020</span> ClassC <span class="number">9</span></span><br><span class="line"><span class="number">2021</span> ClassA <span class="number">12</span></span><br><span class="line"><span class="number">2021</span> ClassB <span class="number">8</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--sql语句</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">year</span>,</span><br><span class="line"><span class="built_in">max</span>(<span class="keyword">case</span> <span class="keyword">when</span> class <span class="operator">=</span> <span class="string">&#x27;ClassA&#x27;</span> <span class="keyword">then</span> score <span class="keyword">end</span>) <span class="keyword">as</span> A,</span><br><span class="line"><span class="built_in">max</span>(<span class="keyword">case</span> <span class="keyword">when</span> class <span class="operator">=</span> <span class="string">&#x27;ClassB&#x27;</span> <span class="keyword">then</span> score <span class="keyword">end</span>) <span class="keyword">as</span> B,</span><br><span class="line"><span class="built_in">max</span>(<span class="keyword">case</span> <span class="keyword">when</span> class <span class="operator">=</span> <span class="string">&#x27;ClassC&#x27;</span> <span class="keyword">then</span> score <span class="keyword">end</span>) <span class="keyword">as</span> C</span><br><span class="line"><span class="keyword">from</span> game</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">year</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--结果</span></span><br><span class="line"><span class="keyword">year</span>	a	b	c</span><br><span class="line"><span class="number">2020</span>	<span class="number">10</span>	<span class="number">12</span>	<span class="number">9</span></span><br><span class="line"><span class="number">2021</span>	<span class="number">12</span>	<span class="number">8</span>	<span class="keyword">NULL</span></span><br></pre></td></tr></table></figure>



<h5 id="连续性问题"><a href="#连续性问题" class="headerlink" title="连续性问题"></a>连续性问题</h5><p>连续3天登录的用户</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--建表语句</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> login(uid <span class="type">int</span>,	dt <span class="type">date</span>, status <span class="type">int</span>)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/temp/sql.txt&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> login;</span><br><span class="line"></span><br><span class="line"><span class="comment">--数据：用户id、日期、是否登录</span></span><br><span class="line"><span class="number">1</span>	<span class="number">2022</span><span class="number">-03</span><span class="number">-01</span>	<span class="number">0</span></span><br><span class="line"><span class="number">1</span>	<span class="number">2022</span><span class="number">-03</span><span class="number">-02</span>	<span class="number">1</span></span><br><span class="line"><span class="number">1</span>	<span class="number">2022</span><span class="number">-03</span><span class="number">-03</span>	<span class="number">1</span></span><br><span class="line"><span class="number">1</span>	<span class="number">2022</span><span class="number">-03</span><span class="number">-04</span>	<span class="number">1</span></span><br><span class="line"><span class="number">1</span>	<span class="number">2022</span><span class="number">-03</span><span class="number">-05</span>	<span class="number">1</span></span><br><span class="line"><span class="number">1</span>	<span class="number">2022</span><span class="number">-03</span><span class="number">-06</span>	<span class="number">0</span></span><br><span class="line"><span class="number">1</span>	<span class="number">2022</span><span class="number">-03</span><span class="number">-07</span>	<span class="number">1</span></span><br><span class="line"><span class="number">2</span>	<span class="number">2022</span><span class="number">-03</span><span class="number">-01</span>	<span class="number">0</span></span><br><span class="line"><span class="number">2</span>	<span class="number">2022</span><span class="number">-03</span><span class="number">-02</span>	<span class="number">1</span></span><br><span class="line"><span class="number">2</span>	<span class="number">2022</span><span class="number">-03</span><span class="number">-03</span>	<span class="number">1</span></span><br><span class="line"><span class="number">2</span>	<span class="number">2022</span><span class="number">-03</span><span class="number">-04</span>	<span class="number">0</span></span><br><span class="line"><span class="number">2</span>	<span class="number">2022</span><span class="number">-03</span><span class="number">-05</span>	<span class="number">0</span></span><br><span class="line"><span class="number">2</span>	<span class="number">2022</span><span class="number">-03</span><span class="number">-06</span>	<span class="number">1</span></span><br><span class="line"><span class="number">2</span>	<span class="number">2022</span><span class="number">-03</span><span class="number">-07</span>	<span class="number">1</span></span><br><span class="line"><span class="number">3</span>	<span class="number">2022</span><span class="number">-03</span><span class="number">-01</span>	<span class="number">1</span></span><br><span class="line"><span class="number">3</span>	<span class="number">2022</span><span class="number">-03</span><span class="number">-02</span>	<span class="number">1</span></span><br><span class="line"><span class="number">3</span>	<span class="number">2022</span><span class="number">-03</span><span class="number">-03</span>	<span class="number">1</span></span><br><span class="line"><span class="number">3</span>	<span class="number">2022</span><span class="number">-03</span><span class="number">-04</span>	<span class="number">0</span></span><br><span class="line"><span class="number">3</span>	<span class="number">2022</span><span class="number">-03</span><span class="number">-05</span>	<span class="number">1</span></span><br><span class="line"><span class="number">3</span>	<span class="number">2022</span><span class="number">-03</span><span class="number">-06</span>	<span class="number">1</span></span><br><span class="line"><span class="number">3</span>	<span class="number">2022</span><span class="number">-03</span><span class="number">-07</span>	<span class="number">1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--sql语句</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="comment">--查询用户在起始日期及其之后的连续登录次数</span></span><br><span class="line">    <span class="keyword">select</span> t1.uid, <span class="built_in">min</span>(t1.dt) <span class="keyword">as</span> start_day, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> day_count</span><br><span class="line">    <span class="keyword">from</span> (</span><br><span class="line">        <span class="comment">--按照用户分组，按照日期递增排序，计算连续登录操作的锚定日期</span></span><br><span class="line">        <span class="keyword">select</span> uid, dt, date_sub(dt, <span class="built_in">row_number</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> uid <span class="keyword">order</span> <span class="keyword">by</span> dt <span class="keyword">asc</span>)) <span class="keyword">as</span> diff</span><br><span class="line">        <span class="keyword">from</span> login</span><br><span class="line">        <span class="keyword">where</span> status <span class="operator">=</span> <span class="number">1</span> <span class="comment">--筛选登录的日期</span></span><br><span class="line">    ) t1</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> t1.uid, t1.diff <span class="comment">--按照用户、锚定日期分组</span></span><br><span class="line">) t2</span><br><span class="line"><span class="keyword">where</span> t2.day_count <span class="operator">&gt;</span> <span class="number">2</span>; <span class="comment">--筛选出至少3次的连续登录操作</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--结果</span></span><br><span class="line">t2.uid	t2.start_day	t2.day_count</span><br><span class="line"><span class="number">1</span>	<span class="number">2022</span><span class="number">-03</span><span class="number">-02</span>	<span class="number">4</span></span><br><span class="line"><span class="number">3</span>	<span class="number">2022</span><span class="number">-03</span><span class="number">-01</span>	<span class="number">3</span></span><br><span class="line"><span class="number">3</span>	<span class="number">2022</span><span class="number">-03</span><span class="number">-05</span>	<span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>连续3年获得冠军的队伍</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--建表语句</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> champion(<span class="keyword">year</span> <span class="type">int</span>, team string)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/temp/sql.txt&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> champion;</span><br><span class="line"></span><br><span class="line"><span class="comment">--数据：年份、获得冠军的队伍</span></span><br><span class="line"><span class="number">2000</span> Sun</span><br><span class="line"><span class="number">2001</span> Lakers</span><br><span class="line"><span class="number">2002</span> Rockets</span><br><span class="line"><span class="number">2003</span> Rockets</span><br><span class="line"><span class="number">2004</span> Rockets</span><br><span class="line"><span class="number">2005</span> Spurs</span><br><span class="line"><span class="number">2006</span> Spurs</span><br><span class="line"><span class="number">2007</span> Sun</span><br><span class="line"><span class="number">2008</span> Lakers</span><br><span class="line"><span class="number">2009</span> Lakers</span><br><span class="line"><span class="number">2010</span> Lakers</span><br><span class="line"><span class="number">2011</span> Lakers</span><br><span class="line"><span class="number">2012</span> Warriors</span><br><span class="line"><span class="number">2013</span> Warriors</span><br><span class="line"><span class="number">2014</span> Warriors</span><br><span class="line"><span class="number">2015</span> Heat</span><br><span class="line"><span class="number">2016</span> Warriors</span><br><span class="line"><span class="number">2017</span> Cavaliers</span><br><span class="line"><span class="number">2018</span> Warriors</span><br><span class="line"><span class="number">2019</span> Sun</span><br><span class="line"><span class="number">2020</span> Warriors</span><br><span class="line"><span class="number">2021</span> Warriors</span><br><span class="line"><span class="number">2022</span> Raptors</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--sql语句</span></span><br><span class="line"><span class="comment">--查询队伍在起始年份及其之后的连续获得冠军的次数</span></span><br><span class="line"><span class="keyword">select</span> t1.team, <span class="built_in">min</span>(t1.year) <span class="keyword">as</span> start_year, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> count</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">	<span class="comment">--按照队伍分组，按照年份递增排序，计算队伍获得冠军的锚定年份</span></span><br><span class="line">	<span class="keyword">select</span> <span class="keyword">year</span>, team, <span class="keyword">year</span> <span class="operator">-</span> <span class="built_in">row_number</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> team <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">year</span> <span class="keyword">asc</span>) <span class="keyword">as</span> diff</span><br><span class="line">	<span class="keyword">from</span> champion</span><br><span class="line">) t1</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> t1.team, t1.diff <span class="comment">--按照队伍、锚定年份分组</span></span><br><span class="line"><span class="keyword">having</span> count <span class="operator">&gt;</span> <span class="number">2</span>; <span class="comment">--筛选出至少3次的连续获得冠军</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--结果</span></span><br><span class="line">t2.team	t2.start_year	t2.count</span><br><span class="line">Lakers	<span class="number">2008</span>	<span class="number">4</span></span><br><span class="line">Rockets	<span class="number">2002</span>	<span class="number">3</span></span><br><span class="line">Warriors	<span class="number">2012</span>	<span class="number">3</span></span><br></pre></td></tr></table></figure>

<h5 id="间隔连续问题"><a href="#间隔连续问题" class="headerlink" title="间隔连续问题"></a>间隔连续问题</h5><p>给定每天登录游戏的所有用户，返回每个用户连续登录的最长天数，间隔一天的两次登录也可以看作连续登录</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--建表语句</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> login(id <span class="type">int</span>, dt <span class="type">date</span>)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/temp/sql.txt&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> login;</span><br><span class="line"></span><br><span class="line"><span class="comment">--数据：用户id、登录日期</span></span><br><span class="line"><span class="number">1001</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-01</span></span><br><span class="line"><span class="number">1002</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-01</span></span><br><span class="line"><span class="number">1003</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-01</span></span><br><span class="line"><span class="number">1001</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-02</span></span><br><span class="line"><span class="number">1002</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-03</span></span><br><span class="line"><span class="number">1001</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-04</span></span><br><span class="line"><span class="number">1002</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-05</span></span><br><span class="line"><span class="number">1003</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-05</span></span><br><span class="line"><span class="number">1001</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-07</span></span><br><span class="line"><span class="number">1002</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-07</span></span><br><span class="line"><span class="number">1003</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-08</span></span><br><span class="line"><span class="number">1001</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-09</span></span><br><span class="line"><span class="number">1002</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-09</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--sql语句</span></span><br><span class="line"><span class="comment">--按照用户id分组，查询每个用户连续登录的最长天数</span></span><br><span class="line"><span class="keyword">select</span> id, <span class="built_in">max</span>(day_count) <span class="keyword">as</span> day_count</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="comment">--按照用户id、flag字段分组，计算登录日期的最大值、最小值之差，表示一次连续登录的天数</span></span><br><span class="line">	<span class="keyword">select</span> id, datediff(<span class="built_in">max</span>(dt), <span class="built_in">min</span>(dt)) <span class="operator">+</span> <span class="number">1</span> <span class="keyword">as</span> day_count</span><br><span class="line">	<span class="keyword">from</span> (</span><br><span class="line">        <span class="comment">--按照用户id分组，按照登录日期递增排序，判断当前登录、上次登录的日期之差是否大于2，累计求和，</span></span><br><span class="line">        <span class="comment">--使得属于连续登录的所有日期具有相同取值的flag字段</span></span><br><span class="line">		<span class="keyword">select</span> id, dt,</span><br><span class="line">		<span class="built_in">sum</span>(if(diff <span class="operator">&gt;</span> <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>)) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> id <span class="keyword">order</span> <span class="keyword">by</span> dt <span class="keyword">asc</span>) <span class="keyword">as</span> flag</span><br><span class="line">		<span class="keyword">from</span> (</span><br><span class="line">            <span class="comment">--查询当前登录、上次登录的日期之差diff</span></span><br><span class="line">			<span class="keyword">select</span> id, dt, </span><br><span class="line">			<span class="keyword">case</span> <span class="keyword">when</span> pre_dt <span class="keyword">is</span> <span class="keyword">null</span> <span class="keyword">then</span> <span class="number">0</span></span><br><span class="line">			<span class="keyword">else</span> datediff(dt, pre_dt) <span class="keyword">end</span> <span class="keyword">as</span> diff</span><br><span class="line">			<span class="keyword">from</span> (</span><br><span class="line">                <span class="comment">--按照用户id分组，按照登录日期递增排序，查询当前登录日期、上次登录日期</span></span><br><span class="line">				<span class="keyword">select</span> id, dt,</span><br><span class="line">				<span class="built_in">lag</span>(dt) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> id <span class="keyword">order</span> <span class="keyword">by</span> dt <span class="keyword">asc</span>) <span class="keyword">as</span> pre_dt</span><br><span class="line">				<span class="keyword">from</span> login</span><br><span class="line">			) t1</span><br><span class="line">		) t2</span><br><span class="line">	) t3</span><br><span class="line">	<span class="keyword">group</span> <span class="keyword">by</span> id, flag</span><br><span class="line">) t4</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> id;</span><br><span class="line"></span><br><span class="line"><span class="comment">--结果</span></span><br><span class="line">id	day_count</span><br><span class="line"><span class="number">1001</span>	<span class="number">4</span></span><br><span class="line"><span class="number">1002</span>	<span class="number">9</span></span><br><span class="line"><span class="number">1003</span>	<span class="number">1</span></span><br></pre></td></tr></table></figure>

<h5 id="波峰波谷问题"><a href="#波峰波谷问题" class="headerlink" title="波峰波谷问题"></a>波峰波谷问题</h5><p>股票价格在时间点上的波峰与波谷</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--建表语句</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> price(stock string, <span class="type">time</span> string, price <span class="type">int</span>)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/temp/sql.txt&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> price;</span><br><span class="line"></span><br><span class="line"><span class="comment">--数据：股票id、时间点、价格</span></span><br><span class="line">A1 <span class="number">06</span>:<span class="number">00</span> <span class="number">12</span></span><br><span class="line">A1 <span class="number">09</span>:<span class="number">00</span> <span class="number">16</span></span><br><span class="line">A1 <span class="number">12</span>:<span class="number">00</span> <span class="number">24</span></span><br><span class="line">A1 <span class="number">15</span>:<span class="number">00</span> <span class="number">17</span></span><br><span class="line">A1 <span class="number">18</span>:<span class="number">00</span> <span class="number">11</span></span><br><span class="line">A1 <span class="number">21</span>:<span class="number">00</span> <span class="number">13</span></span><br><span class="line">B1 <span class="number">06</span>:<span class="number">00</span> <span class="number">18</span></span><br><span class="line">B1 <span class="number">09</span>:<span class="number">00</span> <span class="number">12</span></span><br><span class="line">B1 <span class="number">12</span>:<span class="number">00</span> <span class="number">13</span></span><br><span class="line">B1 <span class="number">15</span>:<span class="number">00</span> <span class="number">13</span></span><br><span class="line">B1 <span class="number">18</span>:<span class="number">00</span> <span class="number">15</span></span><br><span class="line">B1 <span class="number">21</span>:<span class="number">00</span> <span class="number">17</span></span><br><span class="line">C1 <span class="number">06</span>:<span class="number">00</span> <span class="number">12</span></span><br><span class="line">C1 <span class="number">09</span>:<span class="number">00</span> <span class="number">13</span></span><br><span class="line">C1 <span class="number">12</span>:<span class="number">00</span> <span class="number">15</span></span><br><span class="line">C1 <span class="number">15</span>:<span class="number">00</span> <span class="number">17</span></span><br><span class="line">C1 <span class="number">18</span>:<span class="number">00</span> <span class="number">18</span></span><br><span class="line">C1 <span class="number">21</span>:<span class="number">00</span> <span class="number">20</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--sql语句</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> (</span><br><span class="line">    <span class="comment">--查询波峰点</span></span><br><span class="line">    <span class="keyword">select</span> t1.stock, t1.time, t1.price, <span class="string">&#x27;top&#x27;</span> <span class="keyword">as</span> top</span><br><span class="line">    <span class="keyword">from</span> (</span><br><span class="line">        <span class="keyword">select</span> stock, <span class="type">time</span>, price,</span><br><span class="line">        <span class="comment">--按照股票分组，按照时间点递增排序</span></span><br><span class="line">        <span class="built_in">lag</span>(price) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> stock <span class="keyword">order</span> <span class="keyword">by</span> <span class="type">time</span> <span class="keyword">asc</span>) <span class="keyword">as</span> previous, <span class="comment">--前面时间点的价格</span></span><br><span class="line">        <span class="built_in">lead</span>(price) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> stock <span class="keyword">order</span> <span class="keyword">by</span> <span class="type">time</span> <span class="keyword">asc</span>) <span class="keyword">as</span> next <span class="comment">--后面时间点的价格</span></span><br><span class="line">        <span class="keyword">from</span> price</span><br><span class="line">    ) t1</span><br><span class="line">    <span class="keyword">where</span> t1.price <span class="operator">&gt;</span> t1.previous <span class="keyword">and</span> t1.price <span class="operator">&gt;</span> t1.next <span class="comment">--筛选出波峰点</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">union</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">--查询波谷点</span></span><br><span class="line">    <span class="keyword">select</span> t2.stock, t2.time, t2.price, <span class="string">&#x27;down&#x27;</span> <span class="keyword">as</span> top</span><br><span class="line">    <span class="keyword">from</span> (</span><br><span class="line">        <span class="keyword">select</span> stock, <span class="type">time</span>, price,</span><br><span class="line">        <span class="built_in">lag</span>(price) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> stock <span class="keyword">order</span> <span class="keyword">by</span> <span class="type">time</span> <span class="keyword">asc</span>) <span class="keyword">as</span> previous,</span><br><span class="line">        <span class="built_in">lead</span>(price) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> stock <span class="keyword">order</span> <span class="keyword">by</span> <span class="type">time</span> <span class="keyword">asc</span>) <span class="keyword">as</span> next</span><br><span class="line">        <span class="keyword">from</span> price</span><br><span class="line">    ) t2</span><br><span class="line">    <span class="keyword">where</span> t2.price <span class="operator">&lt;</span> t2.previous <span class="keyword">and</span> t2.price <span class="operator">&lt;</span> t2.next <span class="comment">--筛选出波谷点</span></span><br><span class="line">) t3;</span><br><span class="line"></span><br><span class="line"><span class="comment">--结果</span></span><br><span class="line">t3.stock	t3.time	t3.price	t3.top</span><br><span class="line">A1	<span class="number">12</span>:<span class="number">00</span>	<span class="number">24</span>	top</span><br><span class="line">A1	<span class="number">18</span>:<span class="number">00</span>	<span class="number">11</span>	down</span><br><span class="line">B1	<span class="number">09</span>:<span class="number">00</span>	<span class="number">12</span>	down</span><br></pre></td></tr></table></figure>

<h5 id="浏览时长问题"><a href="#浏览时长问题" class="headerlink" title="浏览时长问题"></a>浏览时长问题</h5><p>给定用户在多个时间点上的点击浏览记录，如果两次点击浏览的时间间隔不超过30个单位，则两次浏览属于相同的会话。查询用户在每次会话中的浏览时长、浏览步长，步长表示点击浏览的次数</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--建表语句</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> click(id string, <span class="type">time</span> <span class="type">int</span>)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/temp/sql.txt&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> click;</span><br><span class="line"></span><br><span class="line"><span class="comment">--数据：用户id、点击浏览时间</span></span><br><span class="line">a <span class="number">1001</span></span><br><span class="line">a <span class="number">1005</span></span><br><span class="line">a <span class="number">1020</span></span><br><span class="line">a <span class="number">1048</span></span><br><span class="line">a <span class="number">1078</span></span><br><span class="line">a <span class="number">1230</span></span><br><span class="line">a <span class="number">1245</span></span><br><span class="line">a <span class="number">1270</span></span><br><span class="line">a <span class="number">1282</span></span><br><span class="line">b <span class="number">1101</span></span><br><span class="line">b <span class="number">1132</span></span><br><span class="line">b <span class="number">1156</span></span><br><span class="line">b <span class="number">1180</span></span><br><span class="line">b <span class="number">1200</span></span><br><span class="line">b <span class="number">1230</span></span><br><span class="line">b <span class="number">1345</span></span><br><span class="line">b <span class="number">1370</span></span><br><span class="line">b <span class="number">1400</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--sql语句</span></span><br><span class="line"><span class="comment">--查询用户在每个会话中的起始时间点、点击浏览次数、浏览时长</span></span><br><span class="line"><span class="keyword">select</span> id, <span class="built_in">min</span>(<span class="type">time</span>) <span class="keyword">as</span> start_time, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> count, <span class="built_in">max</span>(<span class="type">time</span>) <span class="operator">-</span> <span class="built_in">min</span>(<span class="type">time</span>) <span class="keyword">as</span> total_time</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="comment">--分组排序后，从上到下计算value列的累加和。如果求和结果相同，则表示属于相同的会话</span></span><br><span class="line">    <span class="keyword">select</span> t2.id, t2.time, <span class="built_in">sum</span>(t2.value) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> id <span class="keyword">order</span> <span class="keyword">by</span> <span class="type">time</span> <span class="keyword">asc</span>) <span class="keyword">as</span> stage</span><br><span class="line">    <span class="keyword">from</span> (</span><br><span class="line">        <span class="comment">--如果与前一次点击的时间之差超过30，则value列为1，否则为0</span></span><br><span class="line">        <span class="comment">--value列为1表示这次点击属于一个新的会话，为0表示这次点击与前一次属于相同的会话</span></span><br><span class="line">        <span class="keyword">select</span> id, <span class="type">time</span>, diff, <span class="keyword">case</span> <span class="keyword">when</span> nvl(diff, <span class="number">9999</span>) <span class="operator">&gt;</span> <span class="number">30</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span> <span class="keyword">value</span></span><br><span class="line">        <span class="keyword">from</span> (</span><br><span class="line">            <span class="comment">--按照用户id分组，按照点击浏览时间递增排序，计算前后两次点击的时间之差</span></span><br><span class="line">            <span class="keyword">select</span> id, <span class="type">time</span>, <span class="type">time</span> <span class="operator">-</span> <span class="built_in">lag</span>(<span class="type">time</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> id <span class="keyword">order</span> <span class="keyword">by</span> <span class="type">time</span> <span class="keyword">asc</span>) <span class="keyword">as</span> diff</span><br><span class="line">            <span class="keyword">from</span> click</span><br><span class="line">        ) t1</span><br><span class="line">    ) t2</span><br><span class="line">) t3</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> id, stage;</span><br><span class="line"></span><br><span class="line"><span class="comment">--结果</span></span><br><span class="line">id	start_time	count	total_time</span><br><span class="line">a	<span class="number">1001</span>	<span class="number">5</span>	<span class="number">77</span></span><br><span class="line">a	<span class="number">1230</span>	<span class="number">4</span>	<span class="number">52</span></span><br><span class="line">b	<span class="number">1101</span>	<span class="number">1</span>	<span class="number">0</span></span><br><span class="line">b	<span class="number">1132</span>	<span class="number">5</span>	<span class="number">98</span></span><br><span class="line">b	<span class="number">1345</span>	<span class="number">3</span>	<span class="number">55</span></span><br></pre></td></tr></table></figure>

<h5 id="活动时长问题"><a href="#活动时长问题" class="headerlink" title="活动时长问题"></a>活动时长问题</h5><p>每个品牌具有多个打折活动，给定每个活动的开始时间、结束时间，返回每个品牌实际参与打折的天数，重复日期不计算在内</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--建表语句</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> discount(brand <span class="type">int</span>, start_dt <span class="type">date</span>, end_dt <span class="type">date</span>)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/temp/sql.txt&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> discount;</span><br><span class="line"></span><br><span class="line"><span class="comment">--数据：品牌id、活动开始时间、活动结束时间</span></span><br><span class="line"><span class="number">1001</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-01</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-03</span></span><br><span class="line"><span class="number">1001</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-05</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-10</span></span><br><span class="line"><span class="number">1002</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-02</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-08</span></span><br><span class="line"><span class="number">1002</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-06</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-09</span></span><br><span class="line"><span class="number">1003</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-12</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-20</span></span><br><span class="line"><span class="number">1003</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-15</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-18</span></span><br><span class="line"><span class="number">1004</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-20</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-25</span></span><br><span class="line"><span class="number">1004</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-22</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-26</span></span><br><span class="line"><span class="number">1004</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-28</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-30</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--sql语句</span></span><br><span class="line"><span class="comment">--按照品牌id分组，计算打折活动的不重复天数之和day_count</span></span><br><span class="line"><span class="keyword">select</span> brand, <span class="built_in">sum</span>(count) <span class="keyword">as</span> day_count</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="comment">--根据当前结束时间的最大值max_dt，计算每行打折活动可以贡献的活动天数count</span></span><br><span class="line">	<span class="keyword">select</span> brand, start_dt, end_dt, max_dt,</span><br><span class="line">	<span class="keyword">case</span> <span class="keyword">when</span> max_dt <span class="keyword">is</span> <span class="keyword">null</span> <span class="keyword">then</span> datediff(end_dt, start_dt) <span class="operator">+</span> <span class="number">1</span></span><br><span class="line">	<span class="keyword">when</span> max_dt <span class="operator">&lt;</span> start_dt <span class="keyword">then</span> datediff(end_dt, start_dt) <span class="operator">+</span> <span class="number">1</span></span><br><span class="line">	<span class="keyword">when</span> max_dt <span class="operator">&lt;</span> end_dt <span class="keyword">then</span> datediff(end_dt, max_dt)</span><br><span class="line">	<span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span> <span class="keyword">as</span> count</span><br><span class="line">	<span class="keyword">from</span> (</span><br><span class="line">        <span class="comment">--按照品牌id分组，按照开始时间、结束时间递增排序，查询当前结束时间的最大值max_dt</span></span><br><span class="line">		<span class="keyword">select</span> brand, start_dt, end_dt,</span><br><span class="line">		<span class="built_in">max</span>(end_dt) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> brand <span class="keyword">order</span> <span class="keyword">by</span> start_dt <span class="keyword">asc</span>, end_dt <span class="keyword">asc</span> <span class="keyword">rows</span> </span><br><span class="line">                         <span class="keyword">between</span> unbounded preceding <span class="keyword">and</span> <span class="number">1</span> preceding) <span class="keyword">as</span> max_dt</span><br><span class="line">		<span class="keyword">from</span> discount</span><br><span class="line">	) t1</span><br><span class="line">) t2</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> brand;</span><br><span class="line"></span><br><span class="line"><span class="comment">--结果</span></span><br><span class="line">brand	day_count</span><br><span class="line"><span class="number">1001</span>	<span class="number">9</span></span><br><span class="line"><span class="number">1002</span>	<span class="number">8</span></span><br><span class="line"><span class="number">1003</span>	<span class="number">9</span></span><br><span class="line"><span class="number">1004</span>	<span class="number">11</span></span><br></pre></td></tr></table></figure>

<h5 id="同时在线问题"><a href="#同时在线问题" class="headerlink" title="同时在线问题"></a>同时在线问题</h5><p>给定每个用户在线的开始时间、结束时间，返回一个时间段与人数，这个时间段具有最多的在线人数</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--建表语句</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> live(id <span class="type">int</span>, start_dt <span class="type">date</span>, end_dt <span class="type">date</span>)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/temp/sql.txt&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> live;</span><br><span class="line"></span><br><span class="line"><span class="comment">--数据：用户id、开始时间、结束时间</span></span><br><span class="line"><span class="number">1001</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-01</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-02</span></span><br><span class="line"><span class="number">1001</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-04</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-05</span></span><br><span class="line"><span class="number">1001</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-07</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-10</span></span><br><span class="line"><span class="number">1001</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-13</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-18</span></span><br><span class="line"><span class="number">1002</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-01</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-02</span></span><br><span class="line"><span class="number">1002</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-04</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-05</span></span><br><span class="line"><span class="number">1002</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-07</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-08</span></span><br><span class="line"><span class="number">1002</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-10</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-11</span></span><br><span class="line"><span class="number">1002</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-13</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-14</span></span><br><span class="line"><span class="number">1002</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-16</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-17</span></span><br><span class="line"><span class="number">1002</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-19</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-20</span></span><br><span class="line"><span class="number">1003</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-01</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-20</span></span><br><span class="line"><span class="number">1004</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-04</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-08</span></span><br><span class="line"><span class="number">1004</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-12</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-16</span></span><br><span class="line"><span class="number">1005</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-03</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-06</span></span><br><span class="line"><span class="number">1005</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-09</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-11</span></span><br><span class="line"><span class="number">1006</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-04</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-06</span></span><br><span class="line"><span class="number">1007</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-09</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-12</span></span><br><span class="line"><span class="number">1008</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-06</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-08</span></span><br><span class="line"><span class="number">1008</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-11</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-13</span></span><br><span class="line"><span class="number">1009</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-06</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-08</span></span><br><span class="line"><span class="number">1009</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-18</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-19</span></span><br><span class="line"><span class="number">1010</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-11</span> <span class="number">2022</span><span class="number">-07</span><span class="number">-14</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--sql语句</span></span><br><span class="line"><span class="keyword">select</span> dt, online</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">	<span class="keyword">select</span> dt, </span><br><span class="line">	<span class="built_in">sum</span>(count) <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> dt <span class="keyword">asc</span>) <span class="keyword">as</span> online</span><br><span class="line">	<span class="keyword">from</span> (</span><br><span class="line">		<span class="keyword">select</span> dt, <span class="built_in">sum</span>(<span class="keyword">value</span>) <span class="keyword">as</span> count</span><br><span class="line">		<span class="keyword">from</span> (</span><br><span class="line">			<span class="keyword">select</span> id, start_dt <span class="keyword">as</span> dt, <span class="number">1</span> <span class="keyword">as</span> <span class="keyword">value</span> <span class="keyword">from</span> live</span><br><span class="line">			<span class="keyword">union</span></span><br><span class="line">			<span class="keyword">select</span> id, date_add(end_dt, <span class="number">1</span>) <span class="keyword">as</span> dt, <span class="number">-1</span> <span class="keyword">as</span> <span class="keyword">value</span> <span class="keyword">from</span> live</span><br><span class="line">		) t1</span><br><span class="line">		<span class="keyword">group</span> <span class="keyword">by</span> dt</span><br><span class="line">	) t2</span><br><span class="line">) t3</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> online <span class="keyword">desc</span>, dt <span class="keyword">asc</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--结果</span></span><br><span class="line">dt	online</span><br><span class="line"><span class="number">2022</span><span class="number">-07</span><span class="number">-04</span>	<span class="number">6</span></span><br><span class="line"><span class="number">2022</span><span class="number">-07</span><span class="number">-06</span>	<span class="number">6</span></span><br><span class="line"><span class="number">2022</span><span class="number">-07</span><span class="number">-07</span>	<span class="number">6</span></span><br><span class="line"><span class="number">2022</span><span class="number">-07</span><span class="number">-11</span>	<span class="number">6</span></span><br><span class="line"><span class="number">2022</span><span class="number">-07</span><span class="number">-13</span>	<span class="number">6</span></span><br><span class="line"><span class="number">2022</span><span class="number">-07</span><span class="number">-10</span>	<span class="number">5</span></span><br><span class="line"><span class="number">2022</span><span class="number">-07</span><span class="number">-12</span>	<span class="number">5</span></span><br><span class="line"><span class="number">2022</span><span class="number">-07</span><span class="number">-14</span>	<span class="number">5</span></span><br><span class="line"><span class="number">2022</span><span class="number">-07</span><span class="number">-09</span>	<span class="number">4</span></span><br><span class="line"><span class="number">2022</span><span class="number">-07</span><span class="number">-16</span>	<span class="number">4</span></span><br><span class="line"><span class="number">2022</span><span class="number">-07</span><span class="number">-01</span>	<span class="number">3</span></span><br><span class="line"><span class="number">2022</span><span class="number">-07</span><span class="number">-15</span>	<span class="number">3</span></span><br><span class="line"><span class="number">2022</span><span class="number">-07</span><span class="number">-17</span>	<span class="number">3</span></span><br><span class="line"><span class="number">2022</span><span class="number">-07</span><span class="number">-18</span>	<span class="number">3</span></span><br><span class="line"><span class="number">2022</span><span class="number">-07</span><span class="number">-19</span>	<span class="number">3</span></span><br><span class="line"><span class="number">2022</span><span class="number">-07</span><span class="number">-03</span>	<span class="number">2</span></span><br><span class="line"><span class="number">2022</span><span class="number">-07</span><span class="number">-20</span>	<span class="number">2</span></span><br><span class="line"><span class="number">2022</span><span class="number">-07</span><span class="number">-21</span>	<span class="number">0</span></span><br></pre></td></tr></table></figure>

<h5 id="区间合并问题"><a href="#区间合并问题" class="headerlink" title="区间合并问题"></a>区间合并问题</h5><p>给定多个时间段，每个时间段分为开始时间、结束时间，将相互重叠的多个时间段合并为一个区间</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--建表语句</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> time_merge(id <span class="type">int</span>, start_time <span class="type">int</span>, end_time <span class="type">int</span>)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/temp/sql.txt&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> time_merge;</span><br><span class="line"></span><br><span class="line"><span class="comment">--数据：id、开始时间、结束时间</span></span><br><span class="line"><span class="number">1</span> <span class="number">12</span> <span class="number">15</span></span><br><span class="line"><span class="number">2</span> <span class="number">57</span> <span class="number">58</span></span><br><span class="line"><span class="number">3</span> <span class="number">29</span> <span class="number">32</span></span><br><span class="line"><span class="number">4</span> <span class="number">30</span> <span class="number">31</span></span><br><span class="line"><span class="number">5</span> <span class="number">17</span> <span class="number">19</span></span><br><span class="line"><span class="number">6</span> <span class="number">44</span> <span class="number">44</span></span><br><span class="line"><span class="number">7</span> <span class="number">56</span> <span class="number">57</span></span><br><span class="line"><span class="number">8</span> <span class="number">16</span> <span class="number">18</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--sql语句</span></span><br><span class="line"><span class="comment">--按照区间序号进行分组，查询每个分组的最小开始时间作为区间开始时间，最大结束时间作为区间结束时间</span></span><br><span class="line"><span class="keyword">select</span> flag, <span class="built_in">min</span>(start_time) <span class="keyword">as</span> start_time, <span class="built_in">max</span>(end_time) <span class="keyword">as</span> end_time</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="comment">--判断哪些时间段属于相同区间，flag表示时间段归属的区间序号，值相同表示属于相同区间</span></span><br><span class="line">	<span class="keyword">select</span> id, start_time, end_time,</span><br><span class="line">	<span class="built_in">sum</span>(count) <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> start_time <span class="keyword">asc</span>, end_time <span class="keyword">asc</span>) <span class="keyword">as</span> flag</span><br><span class="line">	<span class="keyword">from</span> (</span><br><span class="line">        <span class="comment">--根据当前结束时间的最大值max_dt进行比较，标记每个时间段是否为新的区间</span></span><br><span class="line">		<span class="keyword">select</span> id, start_time, end_time,</span><br><span class="line">		<span class="keyword">case</span> <span class="keyword">when</span> max_dt <span class="keyword">is</span> <span class="keyword">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="comment">--作为一个新的区间</span></span><br><span class="line">		<span class="keyword">when</span> max_dt <span class="operator">&lt;</span> start_time <span class="keyword">then</span> <span class="number">1</span> <span class="comment">--作为一个新的区间</span></span><br><span class="line">		<span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span> <span class="keyword">as</span> count <span class="comment">--与前面的区间具有重叠</span></span><br><span class="line">		<span class="keyword">from</span> (</span><br><span class="line">            <span class="comment">--按照开始时间、结束时间递增排序，查询当前结束时间的最大值max_dt</span></span><br><span class="line">			<span class="keyword">select</span> id, start_time, end_time,</span><br><span class="line">			<span class="built_in">max</span>(end_time) <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> start_time <span class="keyword">asc</span>, end_time <span class="keyword">asc</span> <span class="keyword">rows</span> </span><br><span class="line">                               <span class="keyword">between</span> unbounded preceding <span class="keyword">and</span> <span class="number">1</span> preceding) <span class="keyword">as</span> max_dt</span><br><span class="line">			<span class="keyword">from</span> time_merge</span><br><span class="line">		) t1</span><br><span class="line">	) t2</span><br><span class="line">) t3</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> flag</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="comment">--结果</span></span><br><span class="line">flag	start_time	end_time</span><br><span class="line"><span class="number">1</span>	<span class="number">12</span>	<span class="number">15</span></span><br><span class="line"><span class="number">2</span>	<span class="number">16</span>	<span class="number">19</span></span><br><span class="line"><span class="number">3</span>	<span class="number">29</span>	<span class="number">32</span></span><br><span class="line"><span class="number">4</span>	<span class="number">44</span>	<span class="number">44</span></span><br><span class="line"><span class="number">5</span>	<span class="number">56</span>	<span class="number">58</span></span><br></pre></td></tr></table></figure>



<h5 id="共同好友问题"><a href="#共同好友问题" class="headerlink" title="共同好友问题"></a>共同好友问题</h5><p>给定每个用户的好友列表，好友关系是互相对称的，返回任意两个用户的共同好友列表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--建表语句</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> common_friend(id string, friends string)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/temp/sql.txt&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> common_friend;</span><br><span class="line"></span><br><span class="line"><span class="comment">--数据：用户id、好友id列表</span></span><br><span class="line">A B,C,D</span><br><span class="line">B A,C,E</span><br><span class="line">C A,B,D,E,F</span><br><span class="line">D A,C,F</span><br><span class="line">E B,C</span><br><span class="line">F C,D</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--sql语句</span></span><br><span class="line"><span class="comment">--创建临时表，将好友关系分解为最细粒度</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> friend <span class="keyword">as</span></span><br><span class="line"><span class="keyword">select</span> id, friend <span class="keyword">from</span> common_friend <span class="keyword">lateral</span> <span class="keyword">view</span> explode(split(friends, <span class="string">&#x27;,&#x27;</span>)) temp <span class="keyword">as</span> friend;</span><br><span class="line"></span><br><span class="line"><span class="comment">--按照用户的两两组合进行分组，将所有的共同好友放入列表</span></span><br><span class="line"><span class="keyword">select</span> t1.ids, concat_ws(<span class="string">&#x27;,&#x27;</span>, collect_list(t1.friend)) <span class="keyword">as</span> common_friend</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="comment">--将好友关系表与自身进行连接，查询每个用户是哪两个用户的共同好友</span></span><br><span class="line">	<span class="keyword">select</span> a.friend, concat(a.id, <span class="string">&#x27;,&#x27;</span>, b.id) <span class="keyword">as</span> ids</span><br><span class="line">	<span class="keyword">from</span> friend a</span><br><span class="line">	<span class="keyword">join</span> friend b</span><br><span class="line">	<span class="keyword">on</span> a.friend <span class="operator">=</span> b.friend <span class="comment">--按照共同好友进行连接</span></span><br><span class="line">	<span class="keyword">where</span> a.id <span class="operator">&lt;</span> b.id <span class="comment">--筛选出重复记录</span></span><br><span class="line">) t1</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> t1.ids</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="comment">--结果</span></span><br><span class="line">t1.ids	common_friend</span><br><span class="line">A,B	C</span><br><span class="line">A,C	B,D</span><br><span class="line">A,D	C</span><br><span class="line">A,E	B,C</span><br><span class="line">A,F	C,D</span><br><span class="line">B,C	A,E</span><br><span class="line">B,D	A,C</span><br><span class="line">B,E	C</span><br><span class="line">B,F	C</span><br><span class="line">C,D	A,F</span><br><span class="line">C,E	B</span><br><span class="line">C,F	D</span><br><span class="line">D,E	C</span><br><span class="line">D,F	C</span><br><span class="line">E,F	C</span><br></pre></td></tr></table></figure>

<h5 id="可能好友问题"><a href="#可能好友问题" class="headerlink" title="可能好友问题"></a>可能好友问题</h5><p>给定每个用户的好友列表，好友关系是互相对称的，返回每个用户的可能好友。如果两个用户不是好友关系，并且两者拥有至少一个（或者两个）共同好友，则两者互相是可能好友</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--建表语句</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> maybe_friend(id string, friends string)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/temp/sql.txt&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> maybe_friend;</span><br><span class="line"></span><br><span class="line"><span class="comment">--数据：用户id、好友id列表</span></span><br><span class="line">A B,C,D</span><br><span class="line">B A,C,E</span><br><span class="line">C A,B,D,E,F</span><br><span class="line">D A,C,F</span><br><span class="line">E B,C</span><br><span class="line">F C,D</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--sql语句</span></span><br><span class="line"><span class="comment">--创建临时表，将好友关系分解为最细粒度</span></span><br><span class="line"><span class="keyword">with</span> friend <span class="keyword">as</span> (</span><br><span class="line"><span class="keyword">select</span> id, friend <span class="keyword">from</span> common_friend <span class="keyword">lateral</span> <span class="keyword">view</span> explode(split(friends, <span class="string">&#x27;,&#x27;</span>)) temp <span class="keyword">as</span> friend)</span><br><span class="line"></span><br><span class="line"><span class="comment">--将具有至少两个共同好友的临时表与好友关系表进行连接，如果临时表的两个用户是好友关系，则在好友关系表中存在对应记录，否则不存在对应记录，</span></span><br><span class="line"><span class="comment">--表示两者是可能好友</span></span><br><span class="line"><span class="keyword">select</span> t2.id1, t2.id2</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="comment">--查询具有至少两个共同好友的任意两个用户</span></span><br><span class="line">	<span class="keyword">select</span> t1.id1, t1.id2</span><br><span class="line">	<span class="keyword">from</span> (</span><br><span class="line">        <span class="comment">--将好友关系表与自身进行连接，查询任意两个用户具有的共同好友</span></span><br><span class="line">		<span class="keyword">select</span> a.id <span class="keyword">as</span> id1, b.id <span class="keyword">as</span> id2, a.friend</span><br><span class="line">		<span class="keyword">from</span> friend a</span><br><span class="line">		<span class="keyword">join</span> friend b</span><br><span class="line">		<span class="keyword">on</span> a.friend <span class="operator">=</span> b.friend</span><br><span class="line">		<span class="keyword">where</span> a.id <span class="operator">&lt;</span> b.id</span><br><span class="line">	) t1</span><br><span class="line">	<span class="keyword">group</span> <span class="keyword">by</span> t1.id1, t1.id2</span><br><span class="line">	<span class="keyword">having</span> <span class="built_in">count</span>(t1.friend) <span class="operator">&gt;=</span> <span class="number">2</span></span><br><span class="line">) t2</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> friend</span><br><span class="line"><span class="keyword">on</span> t2.id1 <span class="operator">=</span> friend.id</span><br><span class="line"><span class="keyword">and</span> t2.id2 <span class="operator">=</span> friend.friend</span><br><span class="line"><span class="keyword">where</span> friend.id <span class="keyword">is</span> <span class="keyword">null</span> <span class="comment">--排除真实好友，筛选可能好友</span></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="comment">--结果</span></span><br><span class="line">t2.id1	t2.id2</span><br><span class="line">A	E</span><br><span class="line">A	F</span><br><span class="line">B	D</span><br></pre></td></tr></table></figure>

<h5 id="推荐商品问题"><a href="#推荐商品问题" class="headerlink" title="推荐商品问题"></a>推荐商品问题</h5><p>给定一个用户购买一次商品的记录，返回每个用户可能想要购买的商品。如果其余用户与这个用户购买至少两个相同的商品，则其余用户购买、这个用户没有购买的商品，就是这个用户可能想要购买的商品</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--建表语句</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> shop(id string, product <span class="type">int</span>)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/temp/sql.txt&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> shop;</span><br><span class="line"></span><br><span class="line"><span class="comment">--数据：用户id、商品id</span></span><br><span class="line">A <span class="number">1</span></span><br><span class="line">A <span class="number">2</span></span><br><span class="line">A <span class="number">1</span></span><br><span class="line">A <span class="number">3</span></span><br><span class="line">B <span class="number">2</span></span><br><span class="line">B <span class="number">3</span></span><br><span class="line">B <span class="number">4</span></span><br><span class="line">B <span class="number">5</span></span><br><span class="line">B <span class="number">2</span></span><br><span class="line">C <span class="number">1</span></span><br><span class="line">C <span class="number">2</span></span><br><span class="line">C <span class="number">1</span></span><br><span class="line">D <span class="number">1</span></span><br><span class="line">D <span class="number">3</span></span><br><span class="line">D <span class="number">6</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--sql语句</span></span><br><span class="line"><span class="comment">--按照用户、商品进行分组、去重</span></span><br><span class="line"><span class="keyword">with</span> temp <span class="keyword">as</span> (</span><br><span class="line"><span class="keyword">select</span> id, product <span class="keyword">from</span> shop <span class="keyword">group</span> <span class="keyword">by</span> id, product)</span><br><span class="line"></span><br><span class="line"><span class="comment">--将已购买与推荐购买的临时表与已购买表进行连接，如果临时表的商品已购买，则在已购买表中存在对应记录，否则不存在对应记录，表示推荐商品</span></span><br><span class="line"><span class="keyword">select</span> t4.id1 <span class="keyword">as</span> id, t4.product</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="comment">--查询每个用户已购买与推荐购买的商品</span></span><br><span class="line">	<span class="keyword">select</span> t3.id1, t3.product</span><br><span class="line">	<span class="keyword">from</span> (</span><br><span class="line">        <span class="comment">--查询每个用户、以及具有相同购买倾向的其余用户、其余用户已购买的商品</span></span><br><span class="line">		<span class="keyword">select</span> t2.id1, t2.id2, temp.product</span><br><span class="line">		<span class="keyword">from</span> (</span><br><span class="line">            <span class="comment">--查询已购买至少两个相同商品的任意两个用户</span></span><br><span class="line">			<span class="keyword">select</span> t1.id1, t1.id2</span><br><span class="line">			<span class="keyword">from</span> (</span><br><span class="line">                <span class="comment">--查询已购买相同商品的任意两个用户</span></span><br><span class="line">				<span class="keyword">select</span> a.id <span class="keyword">as</span> id1, b.id <span class="keyword">as</span> id2, a.product</span><br><span class="line">				<span class="keyword">from</span> temp a</span><br><span class="line">				<span class="keyword">join</span> temp b</span><br><span class="line">				<span class="keyword">on</span> a.product <span class="operator">=</span> b.product</span><br><span class="line">				<span class="keyword">and</span> a.id <span class="operator">!=</span> b.id </span><br><span class="line">			) t1</span><br><span class="line">			<span class="keyword">group</span> <span class="keyword">by</span> t1.id1, t1.id2</span><br><span class="line">			<span class="keyword">having</span> <span class="built_in">count</span>(t1.product) <span class="operator">&gt;=</span> <span class="number">2</span></span><br><span class="line">		) t2</span><br><span class="line">		<span class="keyword">join</span> temp</span><br><span class="line">		<span class="keyword">on</span> t2.id2 <span class="operator">=</span> temp.id</span><br><span class="line">	) t3</span><br><span class="line">	<span class="keyword">group</span> <span class="keyword">by</span> t3.id1, t3.product</span><br><span class="line">) t4</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> temp</span><br><span class="line"><span class="keyword">on</span> t4.product <span class="operator">=</span> temp.product</span><br><span class="line"><span class="keyword">and</span> t4.id1 <span class="operator">=</span> temp.id <span class="comment">--相同用户购买相同商品</span></span><br><span class="line"><span class="keyword">where</span> temp.product <span class="keyword">is</span> <span class="keyword">null</span> <span class="comment">--排除已购买商品，筛选推荐商品</span></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="comment">--结果</span></span><br><span class="line">id	t4.product</span><br><span class="line">A	<span class="number">4</span></span><br><span class="line">A	<span class="number">5</span></span><br><span class="line">A	<span class="number">6</span></span><br><span class="line">B	<span class="number">1</span></span><br><span class="line">C	<span class="number">3</span></span><br><span class="line">D	<span class="number">2</span></span><br></pre></td></tr></table></figure>









<h5 id="登录行为分析"><a href="#登录行为分析" class="headerlink" title="登录行为分析"></a>登录行为分析</h5><p>有关的统计指标包含：访问量、活跃用户、新增用户、留存用户、流失用户、沉默用户、回流用户</p>
<p>含义解释：（1）活跃用户，每日登录应用的用户，（2）新增用户，在当前日期第一次登录应用的用户，（3）留存用户，在当前日期登录应用的用户，并且在之前日期登录过应用，（4）流失用户，指定时间内没有登录应用的用户，（5）沉默用户，只有第一次登录应用的用户，之后没有登录过应用，（6）回流用户，在当前日期登录应用的用户，并且在之前的指定时间内没有登录过应用</p>
<p>角色分配：活跃、新增 a、留存 b、留存 c、流失 d、沉默 e、回流 f</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--建表语句</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> login_action(uid string, login_date <span class="type">int</span>)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">load data <span class="keyword">local</span> inpath <span class="string">&#x27;/temp/sql.txt&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> login_action;</span><br><span class="line"></span><br><span class="line"><span class="comment">--数据：用户id、登录日期</span></span><br><span class="line">d <span class="number">20220321</span></span><br><span class="line">e <span class="number">20220321</span></span><br><span class="line">f <span class="number">20220321</span></span><br><span class="line"></span><br><span class="line">a <span class="number">20220322</span></span><br><span class="line">b <span class="number">20220322</span></span><br><span class="line">d <span class="number">20220322</span></span><br><span class="line"></span><br><span class="line">a <span class="number">20220323</span></span><br><span class="line">b <span class="number">20220323</span></span><br><span class="line">c <span class="number">20220323</span></span><br><span class="line"></span><br><span class="line">a <span class="number">20220324</span></span><br><span class="line">b <span class="number">20220324</span></span><br><span class="line">c <span class="number">20220324</span></span><br><span class="line"></span><br><span class="line">a <span class="number">20220325</span></span><br><span class="line">b <span class="number">20220325</span></span><br><span class="line">c <span class="number">20220325</span></span><br><span class="line">f <span class="number">20220325</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--活跃用户：</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--新增用户：需要一张全量的用户表，一张某日的登录行为表</span></span><br><span class="line"><span class="comment">--将日期20220321的登录用户作为初始表，表示已知的用户，然后查询日期20220322的新增用户</span></span><br><span class="line"><span class="comment">--登录行为表与全量用户表进行关联，行为表中存在、用户表中不存在的记录表示这个日期的新增用户</span></span><br><span class="line"><span class="comment">--查询出每个日期的新增用户后，需要追加到全量的用户表中</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--全量的用户表：表示用户成为新增用户的日期</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> user_add(uid string, add_date <span class="type">int</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> user_add (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> login_action <span class="keyword">where</span> login_date <span class="operator">=</span> <span class="number">20220321</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> t1.uid, t1.login_date</span><br><span class="line"><span class="keyword">from</span> login_action t1</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> user_add t2</span><br><span class="line"><span class="keyword">on</span> t1.uid <span class="operator">=</span> t2.uid</span><br><span class="line"><span class="keyword">where</span> t1.login_date <span class="operator">=</span> <span class="number">20220322</span> <span class="comment">--查询日期20220322的新增用户</span></span><br><span class="line"><span class="keyword">and</span> t2.uid <span class="keyword">is</span> <span class="keyword">null</span> <span class="comment">--查询在用户表中不存在的记录，即这个日期的新增用户</span></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="comment">--20220322的新增用户</span></span><br><span class="line">t1.uid	t1.add_date</span><br><span class="line">a	<span class="number">20220322</span></span><br><span class="line">b	<span class="number">20220322</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--所有日期的新增用户</span></span><br><span class="line">user_add.uid	user_add.add_date</span><br><span class="line">d	<span class="number">20220321</span></span><br><span class="line">e	<span class="number">20220321</span></span><br><span class="line">f	<span class="number">20220321</span></span><br><span class="line">a	<span class="number">20220322</span></span><br><span class="line">b	<span class="number">20220322</span></span><br><span class="line">c	<span class="number">20220323</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--留存用户：需要一张全量的用户表，一张某日的登录行为表</span></span><br><span class="line"><span class="comment">--登录行为表与全量用户表进行关联，行为表中的登录日期与用户表中的登录日期之差为1天，表示1日的留存用户</span></span><br><span class="line"><span class="comment">--使用union all合并1日、2日的留存用户</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> t1.uid, t1.login_date, t2.add_date</span><br><span class="line"><span class="keyword">from</span> login_action t1</span><br><span class="line"><span class="keyword">join</span> user_add t2</span><br><span class="line"><span class="keyword">on</span> t1.uid <span class="operator">=</span> t2.uid</span><br><span class="line"><span class="keyword">where</span> t1.login_date <span class="operator">=</span> <span class="number">20220324</span> <span class="comment">--查询日期20220324的留存用户</span></span><br><span class="line"><span class="keyword">and</span> t2.add_date <span class="operator">=</span> (<span class="number">20220324</span> <span class="operator">-</span> <span class="number">1</span>) <span class="comment">--查询1日留存用户</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span> <span class="comment">--合并1日、2日留存用户</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> t1.uid, t1.login_date, t2.add_date</span><br><span class="line"><span class="keyword">from</span> login_action t1</span><br><span class="line"><span class="keyword">join</span> user_add t2</span><br><span class="line"><span class="keyword">on</span> t1.uid <span class="operator">=</span> t2.uid</span><br><span class="line"><span class="keyword">where</span> t1.login_date <span class="operator">=</span> <span class="number">20220324</span> <span class="comment">--查询日期20220324的留存用户</span></span><br><span class="line"><span class="keyword">and</span> t2.add_date <span class="operator">=</span> (<span class="number">20220324</span> <span class="operator">-</span> <span class="number">2</span>) <span class="comment">--查询2日留存用户</span></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="comment">--20220324的留存用户：1日、2日</span></span><br><span class="line">_u1.uid	_u1.login_date	_u1.add_date</span><br><span class="line">c	<span class="number">20220324</span>	<span class="number">20220323</span></span><br><span class="line">b	<span class="number">20220324</span>	<span class="number">20220322</span></span><br><span class="line">a	<span class="number">20220324</span>	<span class="number">20220322</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--流失用户：需要一张全量的登录行为表</span></span><br><span class="line"><span class="comment">--查询每个用户的登录日期的最大值，与当前日期之差超过2日，表示流失用户</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> uid, <span class="built_in">max</span>(login_date) <span class="keyword">as</span> last_login</span><br><span class="line"><span class="keyword">from</span> login_action</span><br><span class="line"><span class="keyword">where</span> login_date <span class="operator">&lt;=</span> <span class="number">20220325</span> <span class="comment">--查询日期20220325的流失用户</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> uid</span><br><span class="line"><span class="keyword">having</span> <span class="built_in">max</span>(login_date) <span class="operator">&lt;</span> (<span class="number">20220325</span> <span class="operator">-</span> <span class="number">2</span>) <span class="comment">--超过2日表示流失用户</span></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="comment">--20220325的流失用户</span></span><br><span class="line">uid	last_login</span><br><span class="line">d	<span class="number">20220322</span></span><br><span class="line">e	<span class="number">20220321</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--沉默用户：需要一张全量的登录行为表</span></span><br><span class="line"><span class="comment">--查询每个用户的登录日期的数量，只有一次登录操作，表示沉默用户</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> uid, <span class="built_in">max</span>(login_date) <span class="keyword">as</span> once_login</span><br><span class="line"><span class="keyword">from</span> login_action</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> uid</span><br><span class="line"><span class="keyword">having</span> <span class="built_in">count</span>(login_date) <span class="operator">=</span> <span class="number">1</span> <span class="comment">--只有一次登录操作的用户表示沉默用户</span></span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="comment">--20220325的沉默用户</span></span><br><span class="line">uid	once_login</span><br><span class="line">e	<span class="number">20220321</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--回流用户：需要一张全量的登录行为表</span></span><br><span class="line"><span class="comment">--日期20220325的活跃用户，如果在之前的日期为流失用户，则在日期20220325为回流用户</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> t1.uid, t1.login_date, t2.last_login</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> uid, login_date</span><br><span class="line">    <span class="keyword">from</span> login_action</span><br><span class="line">    <span class="keyword">where</span> login_date <span class="operator">=</span> <span class="number">20220325</span> <span class="comment">--查询20220325的活跃用户</span></span><br><span class="line">) t1</span><br><span class="line"><span class="keyword">join</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span> uid, <span class="built_in">max</span>(login_date) <span class="keyword">as</span> last_login</span><br><span class="line">    <span class="keyword">from</span> login_action</span><br><span class="line">    <span class="keyword">where</span> login_date <span class="operator">&lt;</span> <span class="number">20220325</span> <span class="comment">--查询20220325之前的流失用户</span></span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> uid</span><br><span class="line">    <span class="keyword">having</span> <span class="built_in">max</span>(login_date) <span class="operator">&lt;</span> (<span class="number">20220325</span> <span class="operator">-</span> <span class="number">2</span>)</span><br><span class="line">) t2</span><br><span class="line"><span class="keyword">on</span> t1.uid <span class="operator">=</span> t2.uid</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="comment">--20220325的h用户</span></span><br><span class="line">t1.uid	t1.login_date	t2.last_login</span><br><span class="line">f	<span class="number">20220325</span>	<span class="number">20220321</span></span><br></pre></td></tr></table></figure>

<h5 id="购买行为分析"><a href="#购买行为分析" class="headerlink" title="购买行为分析"></a>购买行为分析</h5><p>有关的统计指标包含：点击量、下单数、支付数</p>
<h5 id="点击行为分析"><a href="#点击行为分析" class="headerlink" title="点击行为分析"></a>点击行为分析</h5><p><strong>JSON解析</strong></p>
<p>解析嵌套Json字符串</p>
<p>get_json_object()方法</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">秋水一色</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2022/08/19/SQL%E7%AC%94%E8%AF%95%E9%A2%98/">http://example.com/2022/08/19/SQL%E7%AC%94%E8%AF%95%E9%A2%98/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Notes</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://s2.loli.net/2022/07/05/3zJOcWHCiKjMVZT.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2022/08/02/DolphinScheduler%E6%90%AD%E5%BB%BA/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2022/07/05/3zJOcWHCiKjMVZT.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">DolphinScheduler搭建</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2022/03/30/mD5ZV7wdUBGl62S.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">秋水一色</div><div class="author-info__description">春风得意马蹄疾,一日看尽长安花</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">43</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/hzh4015"><i class="fab fa-github"></i><span>一起学习，加油！</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/hzh4015" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:hzh4015@163.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="tencent://AddContact/?fromId=45&amp;fromSubId=1&amp;subcmd=all&amp;uin=2597845702&amp;website=www.oicqzone.com" target="_blank" title="QQ"><i class="fab fa-qq"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">这是我的第一个笔记</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#TopN%E9%97%AE%E9%A2%98"><span class="toc-number">1.</span> <span class="toc-text">TopN问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A1%8C%E5%88%97%E8%BD%AC%E6%8D%A2%E9%97%AE%E9%A2%98"><span class="toc-number">2.</span> <span class="toc-text">行列转换问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%9E%E7%BB%AD%E6%80%A7%E9%97%AE%E9%A2%98"><span class="toc-number">3.</span> <span class="toc-text">连续性问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%97%B4%E9%9A%94%E8%BF%9E%E7%BB%AD%E9%97%AE%E9%A2%98"><span class="toc-number">4.</span> <span class="toc-text">间隔连续问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A2%E5%B3%B0%E6%B3%A2%E8%B0%B7%E9%97%AE%E9%A2%98"><span class="toc-number">5.</span> <span class="toc-text">波峰波谷问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E6%97%B6%E9%95%BF%E9%97%AE%E9%A2%98"><span class="toc-number">6.</span> <span class="toc-text">浏览时长问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B4%BB%E5%8A%A8%E6%97%B6%E9%95%BF%E9%97%AE%E9%A2%98"><span class="toc-number">7.</span> <span class="toc-text">活动时长问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%8C%E6%97%B6%E5%9C%A8%E7%BA%BF%E9%97%AE%E9%A2%98"><span class="toc-number">8.</span> <span class="toc-text">同时在线问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8C%BA%E9%97%B4%E5%90%88%E5%B9%B6%E9%97%AE%E9%A2%98"><span class="toc-number">9.</span> <span class="toc-text">区间合并问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B1%E5%90%8C%E5%A5%BD%E5%8F%8B%E9%97%AE%E9%A2%98"><span class="toc-number">10.</span> <span class="toc-text">共同好友问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%AF%E8%83%BD%E5%A5%BD%E5%8F%8B%E9%97%AE%E9%A2%98"><span class="toc-number">11.</span> <span class="toc-text">可能好友问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%A8%E8%8D%90%E5%95%86%E5%93%81%E9%97%AE%E9%A2%98"><span class="toc-number">12.</span> <span class="toc-text">推荐商品问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E8%A1%8C%E4%B8%BA%E5%88%86%E6%9E%90"><span class="toc-number">13.</span> <span class="toc-text">登录行为分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B4%AD%E4%B9%B0%E8%A1%8C%E4%B8%BA%E5%88%86%E6%9E%90"><span class="toc-number">14.</span> <span class="toc-text">购买行为分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%82%B9%E5%87%BB%E8%A1%8C%E4%B8%BA%E5%88%86%E6%9E%90"><span class="toc-number">15.</span> <span class="toc-text">点击行为分析</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/08/19/SQL%E7%AC%94%E8%AF%95%E9%A2%98/" title="无题"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2022/07/05/3zJOcWHCiKjMVZT.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无题"/></a><div class="content"><a class="title" href="/2022/08/19/SQL%E7%AC%94%E8%AF%95%E9%A2%98/" title="无题">无题</a><time datetime="2022-08-19T00:57:49.909Z" title="发表于 2022-08-19 08:57:49">2022-08-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/02/DolphinScheduler%E6%90%AD%E5%BB%BA/" title="DolphinScheduler搭建"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2022/07/05/3zJOcWHCiKjMVZT.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DolphinScheduler搭建"/></a><div class="content"><a class="title" href="/2022/08/02/DolphinScheduler%E6%90%AD%E5%BB%BA/" title="DolphinScheduler搭建">DolphinScheduler搭建</a><time datetime="2022-08-01T16:00:00.000Z" title="发表于 2022-08-02 00:00:00">2022-08-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/07/31/spark%E5%8F%82%E6%95%B0%E4%BC%98%E5%8C%96/" title="spark参数优化"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2022/07/05/3zJOcWHCiKjMVZT.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="spark参数优化"/></a><div class="content"><a class="title" href="/2022/07/31/spark%E5%8F%82%E6%95%B0%E4%BC%98%E5%8C%96/" title="spark参数优化">spark参数优化</a><time datetime="2022-07-30T16:00:00.000Z" title="发表于 2022-07-31 00:00:00">2022-07-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/07/25/kafka%E4%BB%A3%E7%A0%81/" title="Kafka代码"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2022/07/25/dyYNo7VTn5Bw6lc.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Kafka代码"/></a><div class="content"><a class="title" href="/2022/07/25/kafka%E4%BB%A3%E7%A0%81/" title="Kafka代码">Kafka代码</a><time datetime="2022-07-25T14:44:58.432Z" title="发表于 2022-07-25 22:44:58">2022-07-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/07/25/Kafka%E6%90%AD%E5%BB%BA/" title="Kafka搭建"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2022/07/25/dyYNo7VTn5Bw6lc.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Kafka搭建"/></a><div class="content"><a class="title" href="/2022/07/25/Kafka%E6%90%AD%E5%BB%BA/" title="Kafka搭建">Kafka搭建</a><time datetime="2022-07-25T14:24:58.265Z" title="发表于 2022-07-25 22:24:58">2022-07-25</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://s2.loli.net/2022/07/05/3zJOcWHCiKjMVZT.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By 秋水一色</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>